<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>BrickStock - Rangements</title>
        <link rel="stylesheet" type="text/css" href="/BrickStock/css/styles.css">
        <!-- <link rel="stylesheet" type="text/css" href="../css/styles.css"> -->
        <link rel="shortcut icon" href="/BrickStock/css/favicon.ico" type="image/x-icon">
        <!-- <link rel="shortcut icon" href="../css/favicon.ico" type="image/x-icon"> -->
    </head>
    <body>
        <div class="page">
            <div class="menu">
                <ul>
                    <li>
                        <a href="/BrickStock/pieces">Pièces</a></li><li>
                        <a href="/BrickStock/designs">Designs</a></li><li>
                        <a href="/BrickStock/categories">Categories</a></li><li>
                        <a href="/BrickStock/couleurs">Couleurs</a></li><li class="main">
                        <a href="/BrickStock/rangements">Rangements</a></li><li>
                        <a href="/BrickStock/sets">Sets</a></li><li>
                        <a href="/BrickStock/minifigures">Minifigures</a>
                    </li>
                </ul>
            </div>
            <div class="layout">
                <!-- <button id="ajouter" class="ajouter"><img src="/BrickStock/images/bouton_plus_carre.svg"></button> -->
                <div style="text-align: center;">
                    <h3 style="text-align: center;">{path_rangement}</h3>
                    <a style="display: inline-block; position: relative; vertical-align: top; color: inherit; text-decoration: none;" href="{qr_code_href}" target="_blank">
                        <img class="item_img" style="border: none; width: 50px;" src="{qr_code_href}">
                        <br/><span>{id_qr-code}</span>
                    </a>
                    <div class="infos_set">
                        <span>identifiant du rangement&nbsp;: {id_rangement}</span><br/>
                        <span>type de rangement&nbsp;: {type_rangement}</span>
                    </div>
                </div>
                <div style="text-align: left; padding: 24px;" id="list_piece_in_rangement">
                    {content}
                </div>
                <form method="POST" style="margin: 0 24px 24px; text-align: center; width: calc(100% - 48px);">
                    <input type="hidden" name="form_name" value="save_data">
                    <input type="hidden" name="id_rangement" value="{id_rangement}">
                    <input type="hidden" name="liste_pieces" id="liste_pieces_input">
                    <input type="submit" value="ENREGISTRER" class="bouton_validation_infos enregistrer" style="border-radius: 4px; width: 140px;">
                </form>
                <div style="text-align: left; margin: 0 24px; padding: 24px 0; border-top: 1px solid #404040;" id="search_zone">
                    <div class="filter_zone">
                        <a class="bouton_refresh" href="" id="boutonRefresh"></a>
                        <h3>Filtres&nbsp;:</h3>
                        <form method="POST" id="form_search" action="/BrickStock/rangements?id_rangement={id_rangement}#search_zone">
                            <input type="hidden" name="form_name" value="search_piece">
                            <input type="hidden" name="liste_pieces" id="liste_pieces_input_search">
                            <span>Nom&nbsp;:</span><br/>
                            <input type="text" name="nom" value="{nom_search}" placeholder="saisissez un nom" id="filter1"><img src="/BrickStock/images/del_filter.svg" class="del_filter hide" id="del1">
                            <separator></separator>
                            <span>Design&nbsp;:</span><br/>
                            <input type="text" name="id_design" value="{id_design_search}" placeholder="saisissez un nom" id="filter2"><img src="/BrickStock/images/del_filter.svg" class="del_filter hide" id="del2">
                            <separator></separator>
                            <span>Dimensions&nbsp;:</span><br/>
                            <input type="text" name="dimensions" value="{dimensions_search}" placeholder="lxLxh" id="filter3"><img src="/BrickStock/images/del_filter.svg" class="del_filter hide" id="del3">
                            <separator></separator>
                            <span>Catégorie&nbsp;:</span><br/>
                            <select name="categorie" id="filter4">
                                <option value="0">--sélectionner une catégorie--</option>
                                {liste_cat}
                            </select><img src="/BrickStock/images/del_filter.svg" class="del_filter hide" id="del4">
                            <separator></separator>
                            <span>Sous-catégorie&nbsp;:</span><br/>
                            <select name="sous_categorie" id="filter5">
                                <option value="0">--sélectionner une sous-catégorie--</option>
                            </select><img src="/BrickStock/images/del_filter.svg" class="del_filter hide" id="del5">
                            <separator></separator>
                            <input type="submit" value="Rechercher" class="rechercher">
                        </form>
                    </div><div class="table_zone" style="padding: 0; width: calc(100% - 289px - 48px + 24px);">
                        {cases}
                    </div>
                </div>
            </div>
        </div>
        {script}
        <script type="text/javascript" name="gestion filtres - 1/2">
            let defaut = {1 : "", 2 : "", 3 : "", 4 : 0, 5 : 0};
            let indexFilterTon = 0;
            let indexFilterCategories = 4;
        </script>
        <script type="text/javascript" src="/BrickStock/javascript/gestion_filtres.js"></script>
        <script type="text/javascript" name="gestion filtres - 2/2">
            addEventListenerForFiltres(5);
        </script>
        <script type="text/javascript" name="gestion listes déroulantes">
            let filterCategorie = document.getElementById("filter4");
            let filterSousCategorie = document.getElementById("filter5");
            let dictCategories = {liste_sous_categories};
            let listeCategories = {liste_all_categories};
            let categorieFilter = "{categorie_filter}";

            let indexFilterSousCategories = 5;
        </script>
        <script type="text/javascript" src="/BrickStock/javascript/gestion_listes_deroulantes_categories.js"></script>
        <script type="text/javascript" name="data">
            let False = false;
            let resultats = {resultats};
        </script>
        <script type="text/javascript" name="conversion dict (object) -> string et list.remove">
            function str(dict) {
                var chaine = "{";
                var cles = Object.keys(dict)
                for (var i=0; i<cles.length; i++) {
                    if (i > 0) {
                        chaine = chaine + ", ";
                    }
                    chaine = chaine + cles[i] + " : " + dict[cles[i]];
                }
                chaine = chaine + "}";
                return chaine;
            }

            function indexOf(liste, item) {
                for (var i=0; i<liste.length; i++) {
                    if (liste[i] == item) {
                        return i;
                    }
                }
                return -1;
            }

            function listRemove(liste, item) {
                if (liste.includes(item)) {
                    var i = indexOf(liste, item);
                    var new_liste = [];
                    for (var j=0; i<liste.length; j++) {
                        if (j != i) {
                            new_liste.push(liste[j]);
                        }
                    }
                    return new_liste;
                }
                else {
                    return liste;
                }
            }
        </script>
        <script type="text/javascript" name="gestion input liste pieces">
            let valueInput = {value_input};
            let piecesInput = document.getElementById("liste_pieces_input");
            let piecesInputSearch = document.getElementById("liste_pieces_input_search");
            let listeNumItem = [];
            i = 1;
            while (document.getElementById("element" + i) !== null) {
                listeNumItem.push(i);
                i++;
            }
            let nextIndex = listeNumItem.length + 1;
            let nbPiece = Object.keys(valueInput).length;

            function setInput() {
                piecesInput.value = str(valueInput);
                piecesInputSearch.value = piecesInput.value;
            }

            setInput();
        </script>
        <!-- <script type="text/javascript" name="alignement resultats">
            function alignementResultats(nbOnLigne=3) {
                var n = 1;
                for (var i=1; i<=resultats.length; i++) {
                    var item = document.getElementById("resultat" + i);
                    if (item.classList.contains("last")) {
                        item.classList.remove("last");
                    }
                    if (!item.classList.contains("hide")) {
                        if (n % nbOnLigne == 0) {
                            item.classList.add("last");
                        }
                        n++
                    }
                }
            }
        </script> -->
        <script type="text/javascript" name="ajout d'une minifig">
            let zoneElementInRangement = document.getElementById("list_piece_in_rangement");

            function ajouterPiece(e) {
                var n = this.id.substring(14);
                var data = resultats[n - 1];
                var i = nextIndex; // ????????????????????????????????????????
                document.getElementById("resultat" + n).classList.add("hide");
                var divElement = document.createElement("div");
                divElement.classList.add("item_minifig");
                divElement.id = "element" + i;
                var inputType = document.createElement("input");
                inputType.type = "hidden";
                inputType.id = "type_element" + i;
                inputType.value = "piece";
                divElement.appendChild(inputType);
                var inputId = document.createElement("input");
                inputId.type = "hidden";
                inputId.id = "id_element" + i;
                inputId.value = data["id_piece"];
                divElement.appendChild(inputId);
                var imgBoutonSupprimer = document.createElement("img");
                imgBoutonSupprimer.classList.add("supprimer_item");
                imgBoutonSupprimer.src = "/BrickStock/images/croix.svg";
                imgBoutonSupprimer.id = "bouton_supprimer" + i;
                imgBoutonSupprimer.addEventListener("click", supprimerElement);
                divElement.appendChild(imgBoutonSupprimer);
                var imgType = document.createElement("img");
                imgType.classList.add("type_element");
                imgType.src = data["couleur_data"]["image_ref"];
                divElement.appendChild(imgType);
                var imgApercu = document.createElement("img");
                imgApercu.classList.add("apercu");
                imgApercu.src = data["image_ref"];
                divElement.appendChild(imgApercu);
                var span1 = document.createElement("span");
                span1.innerHTML = "id pièce&nbsp;: " + data["id_piece"];
                divElement.appendChild(span1);
                var span2 = document.createElement("span");
                span2.innerHTML = "id design&nbsp;: " + data["id_design"];
                divElement.append(span2);
                var span3 = document.createElement("span");
                span3.style = "font-weight: bold;";
                span3.innerHTML = data["nom"];
                divElement.appendChild(span3);
                zoneElementInRangement.appendChild(divElement);
                listeNumItem.push(i);
                valueInput[data["id_piece"]] = "pièce";
                nextIndex++;
                setInput();
            }

            function ajouterDesign(e) {
                var n = this.id.substring(14);
                var data = resultats[n - 1];
                var i = nextIndex;
                var r = 1;
                while (document.getElementById("resultat" + r) !== null) {
                    if (document.getElementById("id_design" + r) == data["id_design"]) {
                        document.getElementById("resultat" + r).classList.add("hide");
                    }
                }
                var divElement = document.createElement("div");
                divElement.classList.add("item_minifig");
                divElement.id = "element" + i;
                var inputType = document.createElement("input");
                inputType.type = "hidden";
                inputType.id = "type_element" + i;
                inputType.value = "design";
                divElement.appendChild(inputType);
                var inputId = document.createElement("input");
                inputId.type = "hidden";
                inputId.id = "id_element" + i;
                inputId.value = data["id_design"];
                divElement.appendChild(inputId);
                var imgBoutonSupprimer = document.createElement("img");
                imgBoutonSupprimer.classList.add("supprimer_item");
                imgBoutonSupprimer.src = "/BrickStock/images/croix.svg";
                imgBoutonSupprimer.id = "bouton_supprimer" + i;
                imgBoutonSupprimer.addEventListener("click", supprimerElement);
                divElement.appendChild(imgBoutonSupprimer);
                var imgType = document.createElement("img");
                imgType.classList.add("type_element");
                imgType.src = "/BrickStock/images/palette.png";
                divElement.appendChild(imgType);
                var imgApercu = document.createElement("img");
                imgApercu.classList.add("apercu");
                imgApercu.src = data["design_data"]["image_ref"];
                divElement.appendChild(imgApercu);
                var span2 = document.createElement("span");
                span2.innerHTML = "id design&nbsp;: " + data["id_design"];
                divElement.append(span2);
                var span3 = document.createElement("span");
                span3.style = "font-weight: bold;";
                span3.innerHTML = data["nom"];
                divElement.appendChild(span3);
                zoneElementInRangement.appendChild(divElement);
                listeNumItem.push(i);
                valueInput[data["id_design"]] = "design";
                nextIndex++;
                setInput();
            }
            
            var i = 0;
            while (document.getElementById("resultat" + (i + 1)) !== null) {
                i++
            }
            for (var j=1; j<=i; j++) {
                document.getElementById("ajouter_piece_" + j).addEventListener("click", ajouterPiece);
                document.getElementById("ajouter_design" + j).addEventListener("click", ajouterDesign);
            }
        </script>
        <script type="text/javascript" name="suppression de minifig">
            function showResult(idElement) {
                for (var i=0; i<resultats.length; i++) {
                    if (valueInput[idElement] == "pièce") {
                        if (resultats[i]["id_piece"] == idElement) {
                            document.getElementById("resultat" + (i + 1)).classList.remove("hide");
                            return;
                        }
                    }
                    else {
                        if (resultats[i]["id_design"] == idElement) {
                            document.getElementById("resultat" + (i + 1)).classList.remove("hide");
                        }
                    }
                }
            }

            function supprimerElement(e) {
                var i = this.id.substring(16);
                var typeElement = document.getElementById("type_element" + i).innerHTML;
                var idElement = document.getElementById("id_element" + i).value;
                listeNumItem = listRemove(listeNumItem, i);
                showResult(idElement);
                delete valueInput[idElement];
                var item = document.getElementById("element" + i);
                item.classList.add("hide");
                item.innerHTML = "";
                setInput();
            }

            for (var i=0; i<listeNumItem.length; i++) {
                document.getElementById("bouton_supprimer" + listeNumItem[i]).addEventListener("click", supprimerElement);
            }
        </script>
        <script type="text/javascript" name="masquage minifig in set">
            for (var i=1; i<=resultats.length; i++) {
                if (Object.keys(valueInput).includes(document.getElementById("id_piece" + i).value) | Object.keys(valueInput).includes(document.getElementById("id_design" + i).value)) {
                    document.getElementById("resultat" + i).classList.add("hide");
                }
            }
        </script>
    </body>
</html>